pipeline {
    agent any

    environment {
        // Replace with your ArgoCD ingress/LoadBalancer hostname or IP
        ARGOCD_SERVER = "34.93.222.197"   
        ARGOCD_TOKEN  = credentials('argocd-token') // Token stored in Jenkins credentials
        APP_NAME      = "my-kustomize-app"     // ArgoCD application name
    }

    stages {
        stage('Checkout Code') {
            steps {
              echo "checkout done"
                //git branch: 'main', url: 'https://github.com/your-org/your-repo.git'
            }
        }

        stage('Deploy via ArgoCD') {
            steps {
                script {
                    // Install ArgoCD CLI if not already on Jenkins node
                    sh '''
                    if ! command -v argocd &> /dev/null; then
                        echo "Installing ArgoCD CLI..."
                        curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
                        chmod +x argocd
                        sudo mv argocd /usr/local/bin/
                    fi
                    '''

                    // Login using token
                    sh '''
                    argocd login $ARGOCD_SERVER \
                        --auth-token $ARGOCD_TOKEN \
                        --insecure
                    '''

                    // Sync application
                    sh '''
                    argocd app sync $APP_NAME
                    argocd app wait $APP_NAME --timeout 300
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment successful via ArgoCD"
        }
        failure {
            echo "❌ Deployment failed"
        }
    }
}
