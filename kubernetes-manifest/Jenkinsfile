pipeline {
    agent any

    environment {
        // Replace with your ArgoCD ingress/LoadBalancer hostname or IP
        ARGOCD_SERVER = "34.93.222.197:80"   
        APP_NAME      = "my-kustomize-app"     // ArgoCD application name
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo "checkout done"
                // git branch: 'main', url: 'https://github.com/your-org/your-repo.git'
            }
        }

        stage('Deploy via ArgoCD') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'argocd-username-pass', usernameVariable: 'ARGOCD_USER', passwordVariable: 'ARGOCD_PASS')]) {
                    script {
                        // Install ArgoCD CLI if not already on Jenkins node
                        sh '''
                        if command -v argocd >/dev/null 2>&1; then
                            echo "✅ ArgoCD CLI already installed: $(argocd version --client --short)"
                        else
                            echo "⬇️ Installing ArgoCD CLI..."
                            curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
                            chmod +x argocd
                            mkdir -p $HOME/bin
                            mv argocd $HOME/bin/
                            export PATH=$HOME/bin:$PATH
                            echo "✅ ArgoCD CLI installed: $(argocd version --client --short)"
                        fi
                        '''
                        sh '''
                        argocd app create my-kustomize-app \
                          --repo https://github.com/ShivamTiwari05/trial-project.git \
                          --path kubernetes-manifest \
                          --dest-server https://kubernetes.default.svc \
                          --dest-namespace default
                        '''

                        // Login using username & password
                        sh '''
                        argocd login $ARGOCD_SERVER \
                            --username $ARGOCD_USER \
                            --password $ARGOCD_PASS \
                            --insecure
                        '''


                        // to create the application
                        sh '''
                        argocd app create my-kustomize-app \
                          --repo https://github.com/ShivamTiwari05/trial-project.git \
                          --path kubernetes-manifest \
                          --dest-server https://kubernetes.default.svc \
                          --dest-namespace default
                        '''

                        // Sync application
                        sh '''
                        argocd app sync $APP_NAME
                        argocd app wait $APP_NAME --timeout 300
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment successful via ArgoCD"
        }
        failure {
            echo "❌ Deployment failed"
        }
    }
}
