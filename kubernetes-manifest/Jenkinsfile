pipeline {
  agent any

  environment {
    GIT_CREDENTIALS = 'github-creds'
    REPO_URL = 'https://github.com/your-org/your-repo.git'
    KUSTOMIZE_FILE = 'app/kustomization.yaml' // adjust if needed
    ARGOCD_SERVER = 'argocd.yourdomain.com'  // or localhost:8080 if port-forwarded
    ARGOCD_APP = 'your-argocd-app-name'
    ARGOCD_TOKEN = credentials('argocd-token')
  }

  triggers {
    githubPush()
  }

  stages {
    stage('Checkout Code') {
      steps {
        git credentialsId: "${GIT_CREDENTIALS}", url: "${REPO_URL}", branch: 'main'
      }
    }

    stage('Check if kustomization.yaml Changed') {
      steps {
        script {
          def changes = sh(script: 'git diff --name-only HEAD~1 HEAD', returnStdout: true).trim()
          if (!changes.contains("${KUSTOMIZE_FILE}")) {
            echo "No change in ${KUSTOMIZE_FILE}. Skipping ArgoCD deployment."
            currentBuild.result = 'SUCCESS'
            skipDeployment = true
          } else {
            echo "Change detected in ${KUSTOMIZE_FILE}. Proceeding to trigger ArgoCD sync."
          }
        }
      }
    }

    stage('Trigger ArgoCD Sync') {
      when {
        expression { return !binding.hasVariable('skipDeployment') }
      }
      steps {
        sh '''
          curl -k -H "Authorization: Bearer ${ARGOCD_TOKEN}" \
            -X POST https://${ARGOCD_SERVER}/api/v1/applications/${ARGOCD_APP}/sync
        '''
        echo "Triggered ArgoCD sync for app: ${ARGOCD_APP}"
      }
    }
  }
}
